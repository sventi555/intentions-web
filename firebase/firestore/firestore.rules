rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function getIn(collection, id) {
      return get(/databases/$(database)/documents/$(collection)/$(id));
    }

    function isOwner(resourceOwnerId) {
      return request.auth != null && request.auth.uid == resourceOwnerId;
    }

    function isFollowing(userId) {
      return (
        request.auth.uid != null &&
        getIn(/follows, /$(userId)/from/$(request.auth.uid)).data.status == 'accepted'
      );
    }

    function followIncludesMe(fromUserId, toUserId) {
      return request.auth != null && (fromUserId == request.auth.uid || toUserId == request.auth.uid);
    }

    function belongsToFollowed(fromUserId, toUserId) {
      return isFollowing(fromUserId) || isFollowing(toUserId);
    }


    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }

    match /users/{userId} {
      allow read: if true;

      match /feed/{postId} {
        allow read: if isOwner(userId);
      }

      match /notifications/{notificationId} {
        allow read: if isOwner(userId);
      }
    }

    match /follows/{toUserId}/from/{fromUserId} {
      allow read: if (
        followIncludesMe(fromUserId, toUserId) ||
        (resource.data.status == 'accepted' && belongsToFollowed(fromUserId, toUserId))
      );
    }

    match /follows/{fromUserId}/to/{toUserId} {
      allow read: if (
        followIncludesMe(fromUserId, toUserId) ||
        (resource.data.status == 'accepted' && belongsToFollowed(fromUserId, toUserId))
      );
    }

    match /intentions/{intentionId} {
      allow read: if (isOwner(resource.data.userId) || isFollowing(resource.data.userId));
    }

    match /posts/{postId} {
      allow read: if (isOwner(resource.data.userId) || isFollowing(resource.data.userId));

      match /comments/{commentId} {
        function canRead() {
          let postUserId = getIn(/posts, /$(postId)).data.userId;

          return (isOwner(postUserId) || isFollowing(postUserId));
        }

        allow read: if canRead();
      }
    }
  }
}
